<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¸ìƒë„¤ì»· ìƒì„±ê¸° V3 - ì˜ˆìœ ë””ìì¸ ì ìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Inter:wght@400;600;800&family=Lobster&family=Nanum+Pen+Script&family=Do+Hyeon&family=Gothic+A1&family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ë°°ê²½ ì„¤ì • */
        html, body {
            overscroll-behavior-y: contain;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* ì•½ê°„ì˜ ë°°ê²½ìƒ‰ìœ¼ë¡œ ë©”ì¸ ì»¨í…Œì´ë„ˆ ê°•ì¡° */
        }
        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìš°ì„ ) */
        #canvasContainer {
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }
        #photoCanvas {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); /* ë” ë¶€ë“œëŸ¬ìš´ ì„€ë„ìš° */
            border: 1px solid #e5e7eb;
            display: block;
            width: 100%;
            height: auto;
            border-radius: 1rem;
        }
        /* íƒ­ ë° ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .tab-btn.active {
            border-color: #ec4899; /* pink-600 */
            color: #ec4899;
            font-weight: 700;
        }
        .control-btn {
             transition: all 0.2s ease-in-out;
             border: 1px solid #e5e7eb; /* ê¸°ë³¸ ê²½ê³„ */
             padding: 1rem; /* í„°ì¹˜ ì˜ì—­ í™•ì¥ */
             min-width: 100px; /* ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
             text-align: center;
        }
        .control-btn.active {
            transform: scale(1.0); /* í¬ê¸° ë³€í™” ì œê±°, ê·¸ë¦¼ìë§Œ ê°•ì¡° */
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.7); /* í•‘í¬ìƒ‰ ê°•ì¡° ë§ */
            border-color: #ec4899;
            z-index: 10;
        }
        /* ìˆœì„œ ë³€ê²½ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .reorder-mode .preview-item {
            animation: wiggle 0.5s infinite;
        }
        .preview-item.reorder-selected {
            outline: 4px solid #fb7185;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }
        /* ë¡œë” ìŠ¤íƒ€ì¼ */
        #loader {
            backdrop-filter: blur(4px);
        }
        /* ëª¨ë°”ì¼ í°íŠ¸ í¬ê¸° ì¡°ì • */
        h1, h2, h3 {
            word-break: keep-all; /* í•œêµ­ì–´ ë‹¨ì–´ ê¹¨ì§ ë°©ì§€ */
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="w-full max-w-7xl mx-auto bg-white lg:rounded-3xl lg:shadow-2xl lg:my-8 overflow-hidden">
        
        <header class="text-center py-6 border-b border-gray-100 lg:hidden">
            <h1 class="text-3xl font-black text-pink-600">ì¸ìƒë„¤ì»· V3</h1>
            <p class="text-gray-400 text-sm">ëª¨ë°”ì¼ì— ìµœì í™”ëœ í¬í† ë¶€ìŠ¤</p>
        </header>
        
        <main class="flex flex-col lg:flex-row lg:gap-12 lg:p-10">
            
            <div class="w-full lg:w-2/5 p-4 lg:p-0 lg:sticky lg:top-10 self-start">
                <header class="hidden lg:block mb-8 mt-4">
                    <h1 class="text-5xl font-extrabold text-pink-600 tracking-tighter">My Photo Booth</h1>
                    <p class="text-xl text-gray-500 mt-1">ì¸ìƒë„¤ì»· ìƒì„±ê¸° V3</p>
                </header>
                <div id="canvasContainer">
                    <canvas id="photoCanvas"></canvas>
                </div>
            </div>

            <div class="w-full lg:w-3/5">
                <nav class="flex border-b border-gray-200">
                    <button class="tab-btn active flex-1 p-4 font-medium border-b-4 border-transparent text-gray-500 flex items-center justify-center gap-2" data-tab="tab-photo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                        ì‚¬ì§„ ê´€ë¦¬
                    </button>
                    <button class="tab-btn flex-1 p-4 font-medium border-b-4 border-transparent text-gray-500 flex items-center justify-center gap-2" data-tab="tab-design">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                        ë””ìì¸
                    </button>
                    <button class="tab-btn flex-1 p-4 font-medium border-b-4 border-transparent text-gray-500 flex items-center justify-center gap-2" data-tab="tab-text">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v1H7V5zm0 2h2v1H7V7z" clip-rule="evenodd" /></svg>
                        í…ìŠ¤íŠ¸
                    </button>
                     <button class="tab-btn flex-1 p-4 font-medium border-b-4 border-transparent text-gray-500 flex items-center justify-center gap-2" data-tab="tab-save">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        ì €ì¥
                    </button>
                </nav>

                <div class="p-6 space-y-8">
                    <div id="tab-photo" class="tab-content space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <label for="imageUpload" class="w-full bg-pink-500 text-white p-4 rounded-2xl font-bold text-center cursor-pointer hover:bg-pink-600 transition-colors shadow-lg transform hover:scale-[1.01]">ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</label>
                            <label for="cameraUpload" class="w-full bg-purple-500 text-white p-4 rounded-2xl font-bold text-center cursor-pointer hover:bg-purple-600 transition-colors shadow-lg transform hover:scale-[1.01]">ì¦‰ì‹œ ì‚¬ì§„ ì´¬ì˜</label>
                            <input type="file" id="imageUpload" multiple accept="image/*" class="hidden">
                            <input type="file" id="cameraUpload" accept="image/*" capture="user" class="hidden">
                        </div>
                        <div id="imagePreviewsContainer" class="space-y-4">
                            <p id="fileStatus" class="text-sm text-gray-500 h-5"></p>
                            <div id="imagePreviews" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
                        </div>
                        <button id="reorderBtn" class="w-full bg-gray-100 text-gray-700 p-3 rounded-xl font-bold transition-colors shadow-inner hover:bg-gray-200">ìˆœì„œ ë³€ê²½ ì‹œì‘</button>
                    </div>

                    <div id="tab-design" class="tab-content hidden space-y-6">
                        <div>
                           <h3 class="font-bold text-lg mb-2 text-pink-600">ğŸ“ ë ˆì´ì•„ì›ƒ ì„ íƒ</h3>
                           <div id="layoutButtons" class="flex flex-wrap gap-4">
                                <button class="control-btn p-3 rounded-xl shadow-sm border border-gray-200 font-semibold transition-all duration-200 bg-white flex flex-col items-center justify-center text-sm hover:shadow-md active" data-layout="1x4">
                                     <svg width="20" height="40" viewBox="0 0 20 40" fill="currentColor" class="text-pink-600 mb-1"><rect x="5" y="0" width="10" height="8" rx="1"/><rect x="5" y="10" width="10" height="8" rx="1"/><rect x="5" y="20" width="10" height="8" rx="1"/><rect x="5" y="30" width="10" height="8" rx="1"/></svg>
                                    ì„¸ë¡œ 4ì»· (1x4)
                                </button>
                                <button class="control-btn p-3 rounded-xl shadow-sm border border-gray-200 font-semibold transition-all duration-200 bg-white flex flex-col items-center justify-center text-sm hover:shadow-md" data-layout="2x2">
                                    <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor" class="text-pink-600 mb-1"><rect x="2" y="2" width="16" height="16" rx="1"/><rect x="22" y="2" width="16" height="16" rx="1"/><rect x="2" y="22" width="16" height="16" rx="1"/><rect x="22" y="22" width="16" height="16" rx="1"/></svg>
                                    ì •ì‚¬ê° 4ì»· (2x2)
                                </button>
                            </div>
                        </div>
                         <div>
                           <h3 class="font-bold text-lg mb-2 text-pink-600">ğŸ¨ í…Œë§ˆ í”„ë¦¬ì…‹</h3>
                           <div id="themeButtons" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                        </div>
                        <div>
                           <h3 class="font-bold text-lg mb-2 text-pink-600">ğŸŒˆ ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="backgroundColorPicker" class="font-semibold text-gray-600 text-sm">ë°°ê²½ìƒ‰</label>
                                    <input type="color" id="backgroundColorPicker" class="w-full h-10 p-1 mt-1 border rounded-md cursor-pointer hover:shadow-md">
                                </div>
                                <div>
                                    <label for="frameColorPicker" class="font-semibold text-gray-600 text-sm">í”„ë ˆì„ìƒ‰</label>
                                    <input type="color" id="frameColorPicker" class="w-full h-10 p-1 mt-1 border rounded-md cursor-pointer hover:shadow-md">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-text" class="tab-content hidden space-y-4">
                         <h3 class="font-bold text-lg mb-4 text-pink-600">âœï¸ ë¬¸êµ¬ ë° ìŠ¤íƒ€ì¼</h3>
                        <input type="text" id="customTextInput" placeholder="ì—¬ê¸°ì— ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-500 transition-shadow">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                <label for="fontSelector" class="font-semibold text-gray-600">í°íŠ¸</label>
                                <select id="fontSelector" class="w-full p-2 mt-1 border rounded-md focus:ring-2 focus:ring-pink-300">
                                    <option value="Inter">Inter (ê¸°ë³¸)</option>
                                    <option value="Nanum Pen Script">ë‚˜ëˆ”ì†ê¸€ì”¨ íœ</option>
                                    <option value="Caveat">Caveat</option>
                                    <option value="Lobster">Lobster</option>
                                    <option value="Do Hyeon">ë„í˜„</option>
                                    <option value="Gothic A1">ê³ ë”• A1</option>
                                    <option value="Permanent Marker">Permanent Marker</option>
                                </select>
                            </div>
                            <div>
                                <label for="fontColorPicker" class="font-semibold text-gray-600">ìƒ‰ìƒ</label>
                                <input type="color" id="fontColorPicker" class="w-full h-10 p-1 mt-1 border rounded-md cursor-pointer hover:shadow-md">
                            </div>
                        </div>
                         <div>
                            <label for="fontSizeSlider" class="font-semibold text-gray-600">í¬ê¸°: <span id="fontSizeValue">50</span>px</label>
                            <input type="range" id="fontSizeSlider" min="20" max="100" value="50" class="w-full mt-2 h-3 bg-pink-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                     <div id="tab-save" class="tab-content hidden space-y-4">
                        <p class="text-center text-gray-600 text-lg font-medium">âœ¨ ê²°ê³¼ë¬¼ì´ ë§ˆìŒì— ë“œì‹œë‚˜ìš”? <br>ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”!</p>
                        <button id="downloadJpgBtn" class="w-full bg-pink-500 text-white p-4 rounded-xl font-bold text-lg shadow-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-[1.01]">
                            JPEGë¡œ ì €ì¥ (ì¼ë°˜ í™”ì§ˆ)
                        </button>
                        <button id="downloadPngBtn" class="w-full bg-purple-500 text-white p-4 rounded-xl font-bold text-lg shadow-xl hover:bg-purple-600 transition-all duration-300 transform hover:scale-[1.01]">
                            PNGë¡œ ì €ì¥ (ê³ í™”ì§ˆ, ì¶”ì²œ)
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 hidden justify-center items-center z-50">
        <div class="w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        const MAX_IMAGES = 4;
        const canvas = document.getElementById('photoCanvas');
        const ctx = canvas.getContext('2d');
        
        // ìƒˆë¡œìš´ í…Œë§ˆ ì¶”ê°€
        const themes = {
            'pink-soft': { name: 'ğŸ©· í•‘í¬ ê°ì„±', bg: '#fce7f3', frame: '#ffffff', text: '#ec4899' },
            'bw-classic': { name: 'âš«ï¸ í‘ë°± í´ë˜ì‹', bg: '#EEEEEE', frame: '#ffffff', text: '#333333' },
            'blue-cool': { name: 'ğŸ’™ ë¸”ë£¨ ì‹œí¬', bg: '#E0F2FE', frame: '#ffffff', text: '#0284c7' },
            'vintage-sepia': { name: 'ğŸï¸ ë¹ˆí‹°ì§€ ì„¸í”¼ì•„', bg: '#f5e8d9', frame: '#fffbf5', text: '#7f5539' },
            'cozy-autumn': { name: 'ğŸ‚ ì½”ì§€ ì–´í…€', bg: '#f6e4d8', frame: '#ffffff', text: '#c1643c' },
            'winter-snow': { name: 'â„ï¸ ê²¨ìš¸ ëˆˆê½ƒ', bg: '#e0e7ff', frame: '#ffffff', text: '#4338ca' },
            'mint-fresh': { name: 'ğŸƒ ë¯¼íŠ¸ ìƒí¼', bg: '#ccfbf1', frame: '#ffffff', text: '#0d9488' },
            'dark-chic': { name: 'ğŸ–¤ ë‹¤í¬ ì‹œí¬', bg: '#1f2937', frame: '#4b5563', text: '#f3f4f6' },
            'retro-pop': { name: 'ğŸ’– ë ˆíŠ¸ë¡œ íŒ', bg: '#ffedd5', frame: '#fca5a5', text: '#9333ea' },
            'nature-green': { name: 'ğŸŒ¿ ìì—° ì¹œí™”', bg: '#d1fae5', frame: '#a7f3d0', text: '#065f46' },
        };

        // ìƒíƒœ ê´€ë¦¬
        let config = {
            images: [],
            layout: '1x4',
            theme: 'pink-soft',
            backgroundColor: themes['pink-soft'].bg,
            frameColor: themes['pink-soft'].frame,
            customText: {
                content: 'LIFE 4 CUTS',
                font: 'Inter',
                size: 50,
                color: themes['pink-soft'].text
            }
        };
        
        let appState = {
            isReordering: false,
            firstReorderIndex: null,
            activeTab: 'tab-photo'
        };

        // --- ì´ˆê¸°í™” ---
        window.onload = () => {
            setupEventListeners();
            populateThemeButtons();
            updateUIFromConfig();
            setupTabs();
            // í°íŠ¸ ë¡œë“œë¥¼ ìœ„í•œ ì§§ì€ ì§€ì—° (Google Fonts ë¡œë”© ëŒ€ê¸°)
            setTimeout(() => {
                drawCanvas();
            }, 500); 
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupEventListeners() {
            document.getElementById('imageUpload').addEventListener('change', (e) => handleFiles(e.target.files));
            document.getElementById('cameraUpload').addEventListener('change', (e) => handleFiles(e.target.files));

            document.getElementById('layoutButtons').addEventListener('click', (e) => {
                let targetButton = e.target.closest('.control-btn');
                if (targetButton) {
                    config.layout = targetButton.dataset.layout;
                    updateActiveButton(document.getElementById('layoutButtons'), targetButton);
                    drawCanvas();
                }
            });
            
            document.getElementById('reorderBtn').addEventListener('click', toggleReorderMode);

            document.getElementById('backgroundColorPicker').addEventListener('input', (e) => { config.backgroundColor = e.target.value; drawCanvas(); });
            document.getElementById('frameColorPicker').addEventListener('input', (e) => { config.frameColor = e.target.value; drawCanvas(); });
            
            document.getElementById('customTextInput').addEventListener('input', (e) => { config.customText.content = e.target.value; drawCanvas(); });
            document.getElementById('fontSelector').addEventListener('change', (e) => { config.customText.font = e.target.value; drawCanvas(); });
            document.getElementById('fontSizeSlider').addEventListener('input', (e) => {
                config.customText.size = parseInt(e.target.value);
                document.getElementById('fontSizeValue').textContent = e.target.value;
                drawCanvas();
            });
            document.getElementById('fontColorPicker').addEventListener('input', (e) => { config.customText.color = e.target.value; drawCanvas(); });

            document.getElementById('downloadJpgBtn').addEventListener('click', () => downloadImage('jpeg'));
            document.getElementById('downloadPngBtn').addEventListener('click', () => downloadImage('png'));
        }

        // --- íƒ­ ì‹œìŠ¤í…œ ---
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    appState.activeTab = tabId;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => {
                        content.id === tabId ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });
                });
            });
            // ì´ˆê¸° íƒ­ í™œì„±í™” (HTMLì— active í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ ì´ ë¶€ë¶„ì€ í•„ìš”ì—†ì„ ìˆ˜ ìˆìœ¼ë‚˜, ì•ˆì „ì„ ìœ„í•´ ìœ ì§€)
            document.querySelector(`.tab-btn[data-tab="${appState.activeTab}"]`).click();
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function populateThemeButtons() {
            const container = document.getElementById('themeButtons');
            container.innerHTML = '';
            for (const [key, theme] of Object.entries(themes)) {
                const button = document.createElement('button');
                // control-btn ë””ìì¸ í†µì¼ ë° í„°ì¹˜ ì˜ì—­ í™•ë³´
                button.className = 'control-btn p-3 rounded-xl shadow-sm border border-gray-200 text-sm font-semibold transition-all duration-200 text-center bg-white hover:shadow-md';
                // í…Œë§ˆ ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ê°œì„ 
                button.innerHTML = `<div class="w-full h-4 rounded mb-2 border-2 border-dashed border-gray-300" style="background-color: ${theme.bg}; border-color: ${theme.frame === '#ffffff' ? '#e5e7eb' : theme.frame};"></div>${theme.name}`;
                button.dataset.theme = key;
                button.addEventListener('click', () => {
                    config.theme = key;
                    config.backgroundColor = theme.bg;
                    config.frameColor = theme.frame;
                    config.customText.color = theme.text;
                    updateUIFromConfig();
                    drawCanvas();
                });
                container.appendChild(button);
            }
        }
        
        function updateUIFromConfig() {
            updateActiveButton(document.getElementById('themeButtons'), document.querySelector(`[data-theme="${config.theme}"]`));
            updateActiveButton(document.getElementById('layoutButtons'), document.querySelector(`[data-layout="${config.layout}"]`));
            document.getElementById('backgroundColorPicker').value = config.backgroundColor;
            document.getElementById('frameColorPicker').value = config.frameColor;
            document.getElementById('customTextInput').value = config.customText.content;
            document.getElementById('fontSelector').value = config.customText.font;
            document.getElementById('fontSizeSlider').value = config.customText.size;
            document.getElementById('fontSizeValue').textContent = config.customText.size;
            document.getElementById('fontColorPicker').value = config.customText.color;
        }

        function updateActiveButton(container, activeButton) {
            container.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            if (activeButton) activeButton.classList.add('active');
        }

        // --- ì´ë¯¸ì§€ ì²˜ë¦¬ (í„°ì¹˜ ìˆœì„œë³€ê²½ í¬í•¨) ---
        async function handleFiles(files) {
            const fileList = Array.from(files).slice(0, MAX_IMAGES - config.images.length);
            if (fileList.length === 0) {
                 if(config.images.length >= MAX_IMAGES) alert(`ìµœëŒ€ ${MAX_IMAGES}ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                 return;
            }
            showLoader(true);
            document.getElementById('fileStatus').textContent = `${fileList.length}ê°œ ì´ë¯¸ì§€ ë¡œë”© ì¤‘...`;
            for (const file of fileList) {
                try {
                    const img = await loadImage(file);
                    config.images.push({ id: Date.now() + Math.random(), image: img });
                } catch (error) { console.error("Image loading failed:", error); }
            }
            renderImagePreviews();
            drawCanvas();
            showLoader(false);
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = e.target.result; };
                reader.onerror = reject;
                // FileReaderê°€ íŒŒì¼ì„ ë‹¤ ì½ì„ ë•Œê¹Œì§€ ëŒ€ê¸°
                reader.readAsDataURL(file);
            });
        }
        
        function renderImagePreviews() {
            const container = document.getElementById('imagePreviews');
            container.innerHTML = '';
            
            config.images.forEach((imgData, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item relative group aspect-square transition-all duration-300';
                div.dataset.index = index;

                const img = document.createElement('img');
                img.src = imgData.image.src;
                img.className = 'w-full h-full object-cover rounded-lg shadow-md';
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                // ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ ì‚­ì œ ë²„íŠ¼ì´ ë” ì˜ ë³´ì´ë„ë¡ hover í´ë˜ìŠ¤ ì¡°ì • ê°€ëŠ¥
                removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold opacity-0 group-hover:opacity-100 transition-opacity z-10';
                removeBtn.onclick = (e) => { 
                    if (appState.isReordering) return; // ì¬ì •ë ¬ ëª¨ë“œì—ì„œ ì‚­ì œ ë°©ì§€
                    e.stopPropagation(); 
                    removeImage(index); 
                };
                
                div.appendChild(img);
                div.appendChild(removeBtn);
                container.appendChild(div);
                
                // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ í¬í•¨
                div.addEventListener('click', () => handlePreviewClick(index));
            });
            document.getElementById('fileStatus').textContent = `${config.images.length} / ${MAX_IMAGES}ì¥ ì—…ë¡œë“œë¨.`;
        }

        function removeImage(index) {
             if (appState.isReordering) return;
             // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ì´ë¯¸ì§€ ê°ì²´ ì‚­ì œ
             config.images.splice(index, 1);
             renderImagePreviews();
             drawCanvas();
        }

        function toggleReorderMode() {
            appState.isReordering = !appState.isReordering;
            appState.firstReorderIndex = null;
            const btn = document.getElementById('reorderBtn');
            const container = document.getElementById('imagePreviewsContainer');
            
            // ì¬ì •ë ¬ ëª¨ë“œ ì‹œ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€ (UX ê°œì„ )
            document.querySelectorAll('.preview-item button').forEach(b => b.classList.toggle('hidden', appState.isReordering));
            
            container.classList.toggle('reorder-mode', appState.isReordering);
            document.querySelectorAll('.preview-item').forEach(el => el.classList.remove('reorder-selected'));

            if (appState.isReordering) {
                btn.textContent = 'ìˆœì„œ ë³€ê²½ ì™„ë£Œ (ì¬ì •ë ¬ ì·¨ì†Œ)';
                btn.classList.add('bg-pink-500', 'text-white', 'shadow-lg');
                btn.classList.remove('bg-gray-100', 'text-gray-700', 'shadow-inner');
                // ì‚¬ìš©ì ì¹œí™”ì ì¸ ë©”ì‹œì§€
                document.getElementById('fileStatus').textContent = 'âœ… ìˆœì„œë¥¼ ë°”ê¿€ ì‚¬ì§„ ë‘ ì¥ì„ ì°¨ë¡€ë¡œ íƒ­í•˜ì„¸ìš”. (ì™„ë£Œ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì¢…ë£Œ)';
            } else {
                btn.textContent = 'ìˆœì„œ ë³€ê²½ ì‹œì‘';
                btn.classList.remove('bg-pink-500', 'text-white', 'shadow-lg');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'shadow-inner');
                document.getElementById('fileStatus').textContent = `${config.images.length} / ${MAX_IMAGES}ì¥ ì—…ë¡œë“œë¨.`;
            }
        }

        function handlePreviewClick(index) {
            if (!appState.isReordering) return;
            // í´ë¦­ëœ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ë•Œ data-indexë¥¼ ì‚¬ìš© (UIì™€ config.imagesì˜ ë§¤í•‘)
            const clickedEl = document.querySelector(`#imagePreviewsContainer .preview-item[data-index="${index}"]`);

            if (appState.firstReorderIndex === null) {
                // ì²« ë²ˆì§¸ ì‚¬ì§„ ì„ íƒ
                appState.firstReorderIndex = index;
                clickedEl.classList.add('reorder-selected');
                document.getElementById('fileStatus').textContent = 'ğŸ‘‰ ë‘ ë²ˆì§¸ ì‚¬ì§„ì„ íƒ­í•˜ì„¸ìš”.';
            } else {
                // ë‘ ë²ˆì§¸ ì‚¬ì§„ ì„ íƒ ë° êµí™˜
                const firstIndex = appState.firstReorderIndex;
                const secondIndex = index;
                
                // config.images ë°°ì—´ ë‚´ ì´ë¯¸ì§€ ê°ì²´ êµí™˜
                [config.images[firstIndex], config.images[secondIndex]] = [config.images[secondIndex], config.images[firstIndex]];
                
                appState.firstReorderIndex = null;
                renderImagePreviews();
                drawCanvas();
                
                // ë‹¤ìŒ êµí™˜ì„ ìœ„í•´ ì„ íƒ í•´ì œ ë° ë©”ì‹œì§€ ë³µê·€
                document.querySelectorAll('.preview-item').forEach(el => el.classList.remove('reorder-selected'));
                document.getElementById('fileStatus').textContent = 'âœ… ìˆœì„œë¥¼ ë°”ê¿€ ì‚¬ì§„ ë‘ ì¥ì„ ì°¨ë¡€ë¡œ íƒ­í•˜ì„¸ìš”.';
            }
        }

        // --- ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° (ê³ í•´ìƒë„ ëŒ€ì‘) ---
        function drawCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            
            // ìº”ë²„ìŠ¤ ì—˜ë¦¬ë¨¼íŠ¸ í¬ê¸° ì„¤ì •
            canvas.style.width = `${rect.width}px`;
            // ë ˆì´ì•„ì›ƒì— ë”°ë¥¸ ë†’ì´ ë¹„ìœ¨ ì¡°ì • (1x4ëŠ” 3:1, 2x2ëŠ” 1.5:1)
            const displayHeight = rect.width * (config.layout === '1x4' ? 3 : 1.5);
            canvas.style.height = `${displayHeight}px`;

            // ì‹¤ì œ í”½ì…€ í¬ê¸° ì„¤ì • (ê³ í•´ìƒë„)
            const W = rect.width * dpr;
            const H = displayHeight * dpr;
            canvas.width = W;
            canvas.height = H;
            
            // DPR ìŠ¤ì¼€ì¼ë§ì„ ì ìš©í•˜ì—¬ ì´í›„ ì½”ë“œëŠ” ë…¼ë¦¬ì  í”½ì…€(Display í¬ê¸°)ë¡œ ì‘ì—…
            ctx.scale(dpr, dpr);

            // ì—¬ê¸°ì„œë¶€í„°ëŠ” display í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ê·¸ë¦¼
            const displayW = rect.width;
            const displayH = displayHeight;

            // 1. ë°°ê²½ìƒ‰ ì±„ìš°ê¸°
            ctx.fillStyle = config.backgroundColor;
            ctx.fillRect(0, 0, displayW, displayH);
            
            // 2. í”„ë ˆì„ ì˜ì—­ ì •ì˜ ë° ì±„ìš°ê¸°
            const margin = displayW * 0.05;
            const fx = margin, fy = margin, fw = displayW - 2 * margin, fh = displayH - 2 * margin;
            ctx.fillStyle = config.frameColor;
            ctx.fillRect(fx, fy, fw, fh);
            
            // 3. ì‚¬ì§„ ìŠ¬ë¡¯ ê·¸ë¦¬ê¸°
            const p = fw * 0.05; // ë‚´ë¶€ íŒ¨ë”©
            
            if (config.layout === '1x4') {
                const photoW = fw - 2 * p; 
                // ì‚¬ì§„ 4ì¥ + íŒ¨ë”© 5ê°œ (ìœ„/ì•„ë˜ ë§ˆì§„ + ì‚¬ì§„ ì‚¬ì´ 3ê°œ)
                const photoH = (fh - 5 * p) / 4; 
                for (let i = 0; i < 4; i++) {
                    // Y ì¢Œí‘œ: í”„ë ˆì„ Y ì‹œì‘ + ë‚´ë¶€ íŒ¨ë”© + i * (ì‚¬ì§„ ë†’ì´ + íŒ¨ë”©)
                    drawPhotoSlot(i, fx + p, fy + p + (i * (photoH + p)), photoW, photoH);
                }
            } else { // 2x2
                // ì‚¬ì§„ 2ì¥ + íŒ¨ë”© 3ê°œ (ì–‘ìª½ ë§ˆì§„ + ì‚¬ì§„ ì‚¬ì´ 1ê°œ)
                const photoW = (fw - 3 * p) / 2; 
                const photoH = (fh - 3 * p) / 2;
                
                drawPhotoSlot(0, fx + p, fy + p, photoW, photoH);
                drawPhotoSlot(1, fx + 2 * p + photoW, fy + p, photoW, photoH);
                drawPhotoSlot(2, fx + p, fy + 2 * p + photoH, photoW, photoH);
                drawPhotoSlot(3, fx + 2 * p + photoW, fy + 2 * p + photoH, photoW, photoH);
            }
            
            // 4. í…Œë§ˆ íš¨ê³¼ ì ìš©
            applyThemeEffects(fx, fy, fw, fh);
            
            // 5. í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            drawText(displayW, displayH, margin);
        }
        
        // drawPhotoSlot, applyThemeEffects, applyGrayscale í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ì´ ìœ ì§€
        function drawPhotoSlot(i, x, y, w, h) {
            if (i < config.images.length) {
                const img = config.images[i].image; const imgRatio = img.width / img.height; const slotRatio = w / h;
                let sx, sy, sWidth, sHeight;
                if (imgRatio > slotRatio) { sHeight = img.height; sWidth = sHeight * slotRatio; sx = (img.width - sWidth) / 2; sy = 0; } 
                else { sWidth = img.width; sHeight = sWidth / slotRatio; sx = 0; sy = (img.height - sHeight) / 2; }
                ctx.drawImage(img, sx, sy, sWidth, sHeight, x, y, w, h);
            } else {
                ctx.fillStyle = '#e5e7eb'; ctx.fillRect(x, y, w, h); ctx.fillStyle = '#9ca3af';
                ctx.font = '30px Inter'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(`+`, x + w / 2, y + h / 2);
            }
        }
        function applyThemeEffects(fx, fy, fw, fh) { 
            // í‘ë°± í…Œë§ˆ ì™¸ì—ëŠ” ë³„ë„ ì²˜ë¦¬ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ê¸°ì¡´ ë¡œì§ ìœ ì§€
            if(config.theme === 'bw-classic' || config.theme === 'dark-chic') applyGrayscale(fx, fy, fw, fh); 
        }
        function applyGrayscale(x, y, w, h) { 
            const d = ctx.getImageData(x, y, w, h); 
            for (let i = 0; i < d.data.length; i += 4) { 
                const a = (d.data[i] + d.data[i+1] + d.data[i+2]) / 3; 
                d.data[i] = d.data[i+1] = d.data[i+2] = a; 
            } 
            ctx.putImageData(d, x, y); 
        }
        
        // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ìˆ˜ì • (DPR ìŠ¤ì¼€ì¼ë§ ì¼ê´€ì„± í™•ë³´)
        function drawText(W, H, margin) {
            const { content, font, size, color } = config.customText;
            
            // í…ìŠ¤íŠ¸ í¬ê¸°: ìŠ¬ë¼ì´ë” ê°’(size)ì„ ì§ì ‘ ì‚¬ìš© (ìº”ë²„ìŠ¤ DPR ìŠ¤ì¼€ì¼ë§ì— ì˜ì¡´)
            ctx.fillStyle = color; 
            // í°íŠ¸ ì´ë¦„ì— ë”°ì˜´í‘œë¥¼ ì‚¬ìš©í•˜ì—¬ ë„ì–´ì“°ê¸°ê°€ ìˆëŠ” í°íŠ¸ ì²˜ë¦¬
            ctx.font = `bold ${size}px "${font}"`; 
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'middle';
            
            const fw = W - 2 * margin; // í”„ë ˆì„ ë„ˆë¹„
            const fh = H - 2 * margin; // í”„ë ˆì„ ë†’ì´
            const p = fw * 0.05; // ë‚´ë¶€ íŒ¨ë”©
            
            let textY;
            if(config.layout === '1x4'){
                // 1x4 ë ˆì´ì•„ì›ƒ: ë§ˆì§€ë§‰ ì‚¬ì§„ ìŠ¬ë¡¯ ì•„ë˜
                const photoH = (fh - 5 * p) / 4;
                const lastPhotoY = margin + p + (3 * (photoH + p)) + photoH; // ë§ˆì§€ë§‰ ì‚¬ì§„ ìŠ¬ë¡¯ì˜ ì•„ë˜ìª½ ê²½ê³„
                // í…ìŠ¤íŠ¸ëŠ” í”„ë ˆì„ì˜ ë§ˆì§€ë§‰ ì‚¬ì§„ê³¼ ìº”ë²„ìŠ¤ í•˜ë‹¨ ë§ˆì§„ ì‚¬ì´ì˜ ì¤‘ì•™ì— ìœ„ì¹˜
                textY = lastPhotoY + (H - margin - lastPhotoY) / 2;
            } else { // 2x2 ë ˆì´ì•„ì›ƒ: í”„ë ˆì„ ì•„ë˜ìª½ ë§ˆì§„ì˜ ì¤‘ì•™ì— ìœ„ì¹˜
                textY = H - (margin / 2); // ìº”ë²„ìŠ¤ í•˜ë‹¨ ë§ˆì§„ì˜ ì¤‘ì•™
            }
            // ìº”ë²„ìŠ¤ ì¤‘ì•™ì— í…ìŠ¤íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
            if(content) ctx.fillText(content, W / 2, textY);
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function downloadImage(format) {
            if (config.images.length === 0) { alert("ì‚¬ì§„ì„ ë¨¼ì € 1ì¥ ì´ìƒ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!"); return; }
            const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png'; 
            const quality = format === 'jpeg' ? 0.95 : 1.0;
            
            showLoader(true); // ë‹¤ìš´ë¡œë“œ ì „ ë¡œë” í‘œì‹œ

            // drawCanvas()ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ê³ í™”ì§ˆ ë Œë”ë§ (í•„ìš”í•˜ë‹¤ë©´)
            // í˜„ì¬ DPR ë¡œì§ì´ ì´ë¯¸ ê³ í™”ì§ˆì„ ì§€ì›í•˜ë¯€ë¡œ, toDataURL í˜¸ì¶œë§Œìœ¼ë¡œ ì¶©ë¶„

            try {
                const link = document.createElement('a');
                link.href = canvas.toDataURL(mimeType, quality);
                link.download = `inseng4cut_v3_${Date.now()}.${format}`;
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link);
            } catch (e) {
                 alert("ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.");
                 console.error("Download failed:", e);
            }
            
            showLoader(false); // ë‹¤ìš´ë¡œë“œ í›„ ë¡œë” ìˆ¨ê¹€
        }
        
        function showLoader(show) { 
            document.getElementById('loader').classList.toggle('hidden', !show);
            document.getElementById('loader').classList.toggle('flex', show);
        }
        
        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        window.addEventListener('resize', drawCanvas);
    </script>
</body>
</html>